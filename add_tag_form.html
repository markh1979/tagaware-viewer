
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Add Tag - TagAware</title>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: auto; }
    label { display: block; margin-top: 15px; }
    input, select, textarea { width: 100%; padding: 8px; margin-top: 5px; }
    #preview img { max-height: 100px; margin: 5px; }
    #reader { margin-top: 20px; }
  </style>
</head>
<body>
  <h2>Add New Tag</h2>
  <form id="tagForm">
    <input type="hidden" id="SUPABASE_URL" value="https://qzjoylehnxitrddwmcqp.supabase.co" />
    <input type="hidden" id="SUPABASE_ANON_KEY" value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6am95bGVobnhpdHJkZHdtY3FwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI1NTIzMDksImV4cCI6MjA2ODEyODMwOX0.6RSKoL97XuUiA46knx5Sa20i9JCCE94hY-Dt7Iiaj64" />

    <label for="tagId">Tag ID (from QR):</label>
    <input type="text" id="tagId" name="tagId" readonly required />

    <label for="tagType">Tag Type:</label>
    <select id="tagType" name="tagType" required>
      <option value="">-- Select Tag Type --</option>
      <option value="Information tag">Information tag</option>
      <option value="Out of service tag">Out of service tag</option>
      <option value="Danger tag">Danger tag</option>
      <option value="Isolation tag">Isolation tag</option>
      <option value="Scaffold tag">Scaffold tag</option>
    </select>

    <label for="equipment">Equipment Name:</label>
    <input type="text" id="equipment" required />

    <label for="reason">Reason:</label>
    <textarea id="reason" required></textarea>

    <label for="addedBy">Added By (Name):</label>
    <input type="text" id="addedBy" required />

    <label for="area">Area Name:</label>
    <input type="text" id="area" required />

    <label for="gps">GPS Coordinates:</label>
    <input type="text" id="gps" required />

    <label for="photos">Upload up to 5 Photos:</label>
    <input type="file" id="photos" accept="image/*" multiple />
    <div id="preview"></div>

    <button type="submit">Register Tag</button>
  </form>

  <div id="reader"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <script>
    window.onload = function () {
      const supabase = supabase.createClient(
        document.getElementById("SUPABASE_URL").value,
        document.getElementById("SUPABASE_ANON_KEY").value
      );

      const qr = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
      qr.render((decodedText) => {
        document.getElementById("tagId").value = decodedText;
        qr.clear();
        document.getElementById("reader").innerHTML = "✅ QR scanned.";
      }, (error) => {});

      document.getElementById("photos").addEventListener("change", function () {
        const preview = document.getElementById("preview");
        preview.innerHTML = "";
        const files = Array.from(this.files);
        files.forEach(file => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const img = document.createElement("img");
            img.src = e.target.result;
            preview.appendChild(img);
          };
          reader.readAsDataURL(file);
        });
      });

      document.getElementById("tagForm").addEventListener("submit", async function (e) {
        e.preventDefault();
        const tagId = document.getElementById("tagId").value.trim();
        const tagType = document.getElementById("tagType").value;
        const equipment = document.getElementById("equipment").value;
        const reason = document.getElementById("reason").value;
        const addedBy = document.getElementById("addedBy").value;
        const area = document.getElementById("area").value;
        const gps = document.getElementById("gps").value;
        const timestamp = new Date().toISOString();
        const photos = document.getElementById("photos").files;

        const info = { tagId, tagType, equipment, reason, addedBy, area, gps, timestamp };
        const infoBlob = new Blob([JSON.stringify(info, null, 2)], { type: "application/json" });

        const { error: infoError } = await supabase.storage
          .from("tag-public")
          .upload(`${tagId}/info.json`, infoBlob, { upsert: true });

        if (infoError) return alert("❌ Info upload failed: " + infoError.message);

        for (let i = 0; i < photos.length; i++) {
          const file = photos[i];
          const ext = file.name.split('.').pop();
          const path = `${tagId}/photo${i + 1}.${ext}`;
          const { error: photoErr } = await supabase.storage
            .from("tag-public")
            .upload(path, file, { upsert: true });
          if (photoErr) return alert("❌ Photo upload failed: " + photoErr.message);
        }

        alert("✅ Tag registered!");
        this.reset();
        document.getElementById("preview").innerHTML = "";
        document.getElementById("reader").innerHTML = "";
      });
    };
  </script>
</body>
</html>
