<!DOCTYPE html>
<html lang='en'>
<head>
  <meta charset='UTF-8'/>
  <meta name='viewport' content='width=device-width, initial-scale=1.0'/>
  <title>Add Tag - TagAware</title>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: auto; background: #f5f5f5; }
    label { display: block; margin-top: 15px; font-weight: bold; }
    input, select, textarea, button {
      width: 100%; padding: 10px; margin-top: 5px;
      border: 1px solid #ccc; border-radius: 4px;
      box-sizing: border-box;
    }
    button { background-color: #007bff; color: white; border: none; cursor: pointer; }
    button:hover { background-color: #0056b3; }
    #preview img { max-height: 100px; margin: 5px; border-radius: 6px; border: 1px solid #ccc; }
    #reader { margin-top: 20px; }
  </style>
</head>
<body>
  <h2>Add New Tag</h2>
  <form id="tagForm">
    <input type="hidden" id="SUPABASE_URL" value="https://qzjoylehnxitrddwmcqp.supabase.co" />
    <input type="hidden" id="SUPABASE_ANON_KEY" value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6am95bGVobnhpdHJkZHdtY3FwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI1NTIzMDksImV4cCI6MjA2ODEyODMwOX0.6RSKoL97XuUiA46knx5Sa20i9JCCE94hY-Dt7Iiaj64" />

    <label for="tagId">Tag ID (scanned from QR):</label>
    <input type="text" id="tagId" name="tagId" readonly required />
    <button type="button" onclick="startQRScanner()">Scan QR Code</button>
    <div id="reader"></div>

    <label for="tagType">Tag Type:</label>
    <select id="tagType" name="tagType" required>
      <option value="">-- Select Tag Type --</option>
      <option value="Information tag">Information tag</option>
      <option value="Out of service tag">Out of service tag</option>
      <option value="Danger tag">Danger tag</option>
      <option value="Isolation tag">Isolation tag</option>
      <option value="Scaffold tag">Scaffold tag</option>
    </select>

    <label for="equipment">Equipment Name:</label>
    <input type="text" id="equipment" required />

    <label for="reason">Reason:</label>
    <textarea id="reason" required></textarea>

    <label for="addedBy">Added By:</label>
    <input type="text" id="addedBy" required />

    <label for="area">Area:</label>
    <input type="text" id="area" required />

    <label for="gps">GPS Coordinates:</label>
    <input type="text" id="gps" required />

    <label for="photos">Upload Photos (up to 5):</label>
    <input type="file" id="photos" name="photos" accept="image/*" multiple />
    <div id="preview"></div>

    <button type="submit">Submit Tag</button>
  </form>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script>
    const supabase = supabase.createClient(
      document.getElementById("SUPABASE_URL").value,
      document.getElementById("SUPABASE_ANON_KEY").value
    );

    let qrScanner;

    function startQRScanner() {
      const readerElement = document.getElementById("reader");
      readerElement.innerHTML = "";
      qrScanner = new Html5Qrcode("reader");

      qrScanner.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        (decodedText) => {
          document.getElementById("tagId").value = decodedText;
          qrScanner.stop().then(() => {
            readerElement.innerHTML = "✅ QR Code Scanned";
          }).catch(console.error);
        },
        (errorMessage) => {
          console.warn("QR error:", errorMessage);
        }
      ).catch((err) => {
        readerElement.innerHTML = "Camera error: " + err;
      });
    }

    document.getElementById("photos").addEventListener("change", function () {
      const preview = document.getElementById("preview");
      preview.innerHTML = "";
      Array.from(this.files).forEach((file) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = document.createElement("img");
          img.src = e.target.result;
          preview.appendChild(img);
        };
        reader.readAsDataURL(file);
      });
    });

    document.getElementById("tagForm").addEventListener("submit", async function (e) {
      e.preventDefault();
      const tagId = document.getElementById("tagId").value.trim();
      const tagType = document.getElementById("tagType").value;
      const equipment = document.getElementById("equipment").value;
      const reason = document.getElementById("reason").value;
      const addedBy = document.getElementById("addedBy").value;
      const area = document.getElementById("area").value;
      const gps = document.getElementById("gps").value;
      const timestamp = new Date().toISOString();
      const photos = document.getElementById("photos").files;

      const info = { tagId, tagType, equipment, reason, addedBy, area, gps, timestamp };
      const infoBlob = new Blob([JSON.stringify(info, null, 2)], { type: "application/json" });

      const { error: infoError } = await supabase.storage
        .from("tag-public")
        .upload(`${tagId}/info.json`, infoBlob, { upsert: true });

      if (infoError) return alert("❌ Failed to upload tag info: " + infoError.message);

      for (let i = 0; i < photos.length; i++) {
        const file = photos[i];
        const ext = file.name.split('.').pop();
        const path = `${tagId}/photo${i + 1}.${ext}`;
        const { error: photoError } = await supabase.storage
          .from("tag-public")
          .upload(path, file, { upsert: true });
        if (photoError) return alert("❌ Failed to upload photo: " + photoError.message);
      }

      alert("✅ Tag successfully registered!");
      document.getElementById("tagForm").reset();
      document.getElementById("preview").innerHTML = "";
      document.getElementById("reader").innerHTML = "";
    });
  </script>
</body>
</html>
